import{g as ae,s as D,j as e,r as S,y as T}from"./index-DMwWV6LZ.js";import{u as oe,q as _}from"./queryKeys-B8YbpHg6.js";import{u as z}from"./useMutation-rOajDVhN.js";import{C as re,a as te,b as ne,c as le}from"./card-CZDdEFOl.js";import{I as ie}from"./input-D6FpiF2T.js";import{S as H,a as Y,b as X,c as G,d as $,T as ce,e as me,f as V,g as B,h as de,i as f}from"./table-BhjpBg1z.js";import{S as ue,F as xe,r as he,u as O,C as W,a as pe}from"./readXlsxFileBrowser-B_cWmW9H.js";import{B as K}from"./badge-lPAdpJMK.js";import{B as C}from"./button-DdLPv1v6.js";import{L as ye,A as fe,a as je,C as Z}from"./alert-CjM6HumU.js";import{C as ge}from"./circle-alert-DaODrJr0.js";import{M as we}from"./map-pin-ZKOn9kME.js";import{P as be}from"./plus-DJfzYg-M.js";import{A as Ne}from"./index-Bs2UPQaf.js";import{m as ee}from"./proxy-BVDPlYaL.js";import{X as se}from"./x-DXQQL3e4.js";import{U as Ce}from"./users-BpObsUQF.js";import{T as Se}from"./trash-2-CGwPMucJ.js";import"./index-Dy3eTchR.js";import"./index-CK0ERQAK.js";import"./index-B5rXH1kc.js";import"./createLucideIcon-De5o52GV.js";const ve=Object.freeze([]);async function Re(){const{data:o,error:a}=await D.from("room").select("*");if(a)throw new Error(a.message||"Failed to load rooms");return o??[]}async function Ee(o){const{data:a,error:n}=await D.from("room").insert([o]).select("*").single();if(n)throw new Error(n.message||"Failed to create room");return a}async function _e({id:o,updates:a}){const{data:n,error:m}=await D.from("room").update(a).eq("id",o).select("*").single();if(m)throw new Error(m.message||"Failed to update room");return n}async function Te(o){const{error:a}=await D.from("room").delete().eq("id",o);if(a)throw new Error(a.message||"Failed to delete room");return{id:o}}function J({roomsQueryOptions:o={},createOptions:a,updateOptions:n,deleteOptions:m}={}){const t=ae(),h=oe({queryKey:_.rooms.all,queryFn:Re,staleTime:6e4,...o}),p=z({mutationFn:Ee,onSuccess:async(l,i,d)=>{t.setQueryData(_.rooms.all,u=>{const r=Array.isArray(u)?u:[];return[l,...r]}),await t.invalidateQueries({queryKey:_.rooms.all}),a?.onSuccess&&a.onSuccess(l,i,d)},onError:(l,i,d)=>{a?.onError&&a.onError(l,i,d)},...a}),j=z({mutationFn:_e,onSuccess:async(l,i,d)=>{t.setQueryData(_.rooms.all,u=>Array.isArray(u)?u.map(r=>r?.id===l?.id?{...r,...l}:r):u),await t.invalidateQueries({queryKey:_.rooms.all}),n?.onSuccess&&n.onSuccess(l,i,d)},onError:(l,i,d)=>{n?.onError&&n.onError(l,i,d)},...n}),g=z({mutationFn:Te,onSuccess:async(l,i,d)=>{const u=l?.id??i;t.setQueryData(_.rooms.all,r=>Array.isArray(r)?r.filter(c=>c?.id!==u):r),await t.invalidateQueries({queryKey:_.rooms.all}),m?.onSuccess&&m.onSuccess(l,i,d)},onError:(l,i,d)=>{m?.onError&&m.onError(l,i,d)},...m}),b=!!(p.isPending||j.isPending),y=!!g.isPending,q=p.mutateAsync,v=j.mutateAsync,R=g.mutateAsync,A=h.isLoading,w=h.isError,N=h.error??null;return{rooms:h.data??ve,isLoading:A,isError:w,error:N,refetch:h.refetch,roomsQuery:h,createRoomAsync:q,updateRoomAsync:v,deleteRoomAsync:R,createStatus:p,updateStatus:j,deleteStatus:g,isSubmitting:b,isDeleting:y}}const Q=["Lecture","Lab"],Ae={Lecture:"bg-blue-50 text-blue-700 border-blue-200",Lab:"bg-green-50 text-green-700 border-green-200"},Fe=["room_number","capacity","room_type"];function Le({searchTerm:o,setSearchTerm:a,selectedType:n,setSelectedType:m}){return e.jsx(re,{children:e.jsx(te,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(ue,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(ie,{placeholder:"Search rooms...",value:o,onChange:t=>a(t.target.value),className:"pl-10"})]}),e.jsxs(H,{value:n,onValueChange:m,children:[e.jsx(Y,{className:"w-[200px]",children:e.jsx(X,{placeholder:"All Room Types"})}),e.jsxs(G,{children:[e.jsx($,{value:"all",children:"All Room Types"}),Q.map(t=>e.jsx($,{value:t,children:t},t))]})]})]})})})}function Ie(){const{rooms:o,createRoomAsync:a,updateRoomAsync:n}=J(),[m,t]=S.useState(""),[h,p]=S.useState(!1),j=async g=>{const b=g.target.files?.[0];if(b){p(!0),t("");try{const y=await he(b);if(!y.length){t("The file appears to be empty."),p(!1);return}const v=y[0].map(r=>r&&typeof r=="string"?r.trim().toLowerCase():""),R=Fe.filter(r=>!v.includes(r.toLowerCase()));if(R.length>0){t(`Missing required columns: ${R.join(", ")}`),p(!1);return}const A=v.includes("name"),w={};v.forEach((r,c)=>{r&&(w[r]=c)});const N=[],l=[];for(let r=1;r<y.length;r++){const c=y[r];if(!c||c.every(P=>P===null||P===""))continue;const E=c[w.room_number],M=c[w.capacity],k=c[w.room_type],U=A?c[w.name]:void 0;if(!E||!k||!M&&M!==0)continue;const F=parseInt(M,10);if(isNaN(F)||F<=0)continue;const s=String(k).trim();if(!Q.includes(s))continue;const x=String(E).trim(),L={room_number:x,capacity:F,room_type:s};A&&U&&(L.name=String(U).trim());const I=o.find(P=>P.room_number?.toLowerCase()===x.toLowerCase());I?l.push({id:I.id,updates:L}):N.push(L)}if(N.length===0&&l.length===0){t("No valid room rows found to import."),p(!1);return}let i=0,d=0;const u=[];for(const r of N)try{await a(r),i++}catch(c){u.push(`Create error for ${r.room_number}: ${c?.message||c}`)}for(const{id:r,updates:c}of l)try{await n({id:r,updates:c}),d++}catch(E){u.push(`Update error for ${c.room_number}: ${E?.message||E}`)}u.length>0&&t(u.join(`
`)),(i||d)&&T.success(`Import complete: ${i} created, ${d} updated.`),g.target.value=null}catch(y){t(`Error processing file: ${y?.message||String(y)}`)}finally{p(!1)}}};return e.jsxs("div",{children:[e.jsx(C,{variant:"outline",onClick:()=>document.getElementById("roomExcelFileInput").click(),disabled:h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4 mr-2"}),"Import Excel"]})}),e.jsx("input",{id:"roomExcelFileInput",type:"file",className:"hidden",accept:".xlsx",onChange:j,disabled:h}),m&&e.jsxs(fe,{variant:"destructive",className:"mt-4 whitespace-pre-wrap",children:[e.jsx(ge,{className:"h-4 w-4"}),e.jsx(je,{children:m})]})]})}function qe({rooms:o,loading:a}){const{createRoomAsync:n,updateRoomAsync:m,deleteRoomAsync:t}=J(),[h,p]=S.useState(null),[j,g]=S.useState(!1),[b,y]=S.useState(null),{register:q,handleSubmit:v,reset:R,control:A,formState:{errors:w}}=O(),{register:N,handleSubmit:l,reset:i,control:d,setValue:u,formState:{errors:r}}=O(),c=async s=>{if(confirm("Are you sure you want to delete this room?"))try{await t(s),T.success("Room deleted successfully!")}catch(x){T.error(`Delete failed: ${x?.message||x}`)}},E=s=>{y(s.id),u("room_number",s.room_number),u("room_type",s.room_type),u("capacity",s.capacity)},M=async s=>{try{await n({room_number:s.room_number.trim(),room_type:s.room_type,capacity:parseInt(s.capacity,10)}),T.success("Room created successfully!"),R(),g(!1)}catch(x){T.error(`Create failed: ${x?.message||x}`)}},k=async s=>{try{await m({id:b,updates:{room_number:s.room_number.trim(),room_type:s.room_type,capacity:parseInt(s.capacity,10)}}),T.success("Room updated successfully!"),y(null),i()}catch(x){T.error(`Update failed: ${x?.message||x}`)}};w&&Object.keys(w).length||r&&Object.keys(r).length;const U=({onClick:s})=>e.jsx(C,{size:"sm",variant:"outline",onClick:s,children:e.jsx(pe,{className:"w-3 h-3"})}),F=({onClick:s})=>e.jsx(C,{size:"sm",variant:"outline",onClick:s,className:"text-red-600 hover:text-red-700",children:e.jsx(Se,{className:"w-3 h-3"})});return e.jsxs(re,{children:[e.jsx(ne,{children:e.jsxs(le,{className:"flex items-center gap-2",children:[e.jsx(we,{className:"w-5 h-5"}),"Rooms (",o.length,")",e.jsxs("div",{className:"flex gap-2 ml-auto",children:[e.jsxs(C,{className:"bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700",onClick:()=>{g(!0),y(null)},children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Add Room"]}),e.jsx(Ie,{})]})]})}),e.jsx(te,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ce,{className:"table-fixed w-full",children:[e.jsx(me,{children:e.jsxs(V,{children:[e.jsx(B,{className:"w-[25%]",children:"Room"}),e.jsx(B,{className:"w-[25%]",children:"Type"}),e.jsx(B,{className:"w-[20%]",children:"Capacity"}),e.jsx(B,{className:"w-[20%]"})]})}),e.jsx(de,{children:e.jsxs(Ne,{children:[a?e.jsx(V,{children:e.jsx(f,{colSpan:4,className:"text-center py-8",children:"Loading rooms..."})}):o.length===0&&!j?e.jsx(V,{children:e.jsx(f,{colSpan:4,className:"text-center py-8",children:"No rooms found"})}):o.map((s,x)=>e.jsx(ee.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:x*.05},className:"hover:bg-slate-50",onMouseEnter:()=>p(s.id),onMouseLeave:()=>p(null),children:b===s.id?e.jsxs(e.Fragment,{children:[e.jsx(f,{children:e.jsx("input",{...N("room_number",{required:!0}),className:"w-full border px-2 py-1 rounded",placeholder:"Room Number"})}),e.jsx(f,{children:e.jsx(W,{name:"room_type",control:d,rules:{required:!0},render:({field:L})=>e.jsxs(H,{value:L.value,onValueChange:L.onChange,children:[e.jsx(Y,{className:"w-full",children:e.jsx(X,{placeholder:"Type"})}),e.jsx(G,{children:Q.map(I=>e.jsx($,{value:I,children:e.jsx(K,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:I})},I))})]})})}),e.jsx(f,{children:e.jsx("input",{type:"number",min:"1",...N("capacity",{required:!0,min:1}),className:"w-full border px-2 py-1 rounded",placeholder:"Capacity"})}),e.jsx(f,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{size:"sm",variant:"outline",onClick:()=>{y(null),i()},children:e.jsx(se,{className:"w-3 h-3"})}),e.jsx(C,{size:"sm",className:"bg-green-500 text-white",onClick:l(k),children:e.jsx(Z,{className:"w-3 h-3"})})]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(f,{children:[e.jsx("div",{className:"font-medium",children:s.room_number}),s.name&&e.jsx("div",{className:"text-xs text-slate-500 mt-1",children:s.name})]}),e.jsx(f,{children:e.jsx(K,{variant:"outline",className:Ae[s.room_type]||"bg-gray-50 text-gray-700  border-border-200",children:s.room_type})}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3 text-slate-400"})," ",s.capacity]})}),e.jsx(f,{children:e.jsx("div",{className:"flex gap-2",children:h===s.id?e.jsxs(e.Fragment,{children:[e.jsx(U,{onClick:()=>E(s)}),e.jsx(F,{onClick:()=>c(s.id)})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{visibility:"hidden"},children:e.jsx(U,{})}),e.jsx("span",{style:{visibility:"hidden"},children:e.jsx(F,{})})]})})})]})},s.id)),j&&e.jsxs(ee.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},children:[e.jsx(f,{children:e.jsx("input",{type:"text",placeholder:"Room Number",className:"w-full border px-2 py-1 rounded",...q("room_number",{required:!0})})}),e.jsx(f,{children:e.jsx(W,{name:"room_type",control:A,rules:{required:!0},render:({field:s})=>e.jsxs(H,{value:s.value,onValueChange:s.onChange,children:[e.jsx(Y,{className:"w-full",children:e.jsx(X,{placeholder:"Type"})}),e.jsx(G,{children:Q.map(x=>e.jsx($,{value:x,children:e.jsx(K,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:x})},x))})]})})}),e.jsx(f,{children:e.jsx("input",{type:"number",placeholder:"Capacity",className:"w-full border px-2 py-1 rounded",...q("capacity",{required:!0,min:1}),min:"1"})}),e.jsx(f,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{size:"sm",variant:"outline",onClick:()=>{R(),g(!1)},children:e.jsx(se,{className:"w-3 h-3"})}),e.jsx(C,{size:"sm",className:"bg-green-500 text-white",onClick:v(M),children:e.jsx(Z,{className:"w-3 h-3"})})]})})]},"new-row")]})})]})})})]})}function ts(){const{rooms:o,isLoading:a}=J(),[n,m]=S.useState(""),[t,h]=S.useState("all"),p=S.useMemo(()=>o.filter(j=>{const g=(j.room_number??"").toLowerCase().includes(n.toLowerCase())||(j.name??"").toLowerCase().includes(n.toLowerCase()),b=t==="all"||j.room_type===t;return g&&b}),[o,n,t]);return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Rooms Management"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Manage classroom and facility resources"})]})}),e.jsx(Le,{searchTerm:n,setSearchTerm:m,selectedType:t,setSelectedType:h}),e.jsx(qe,{rooms:p,loading:a})]})}export{ts as default};
