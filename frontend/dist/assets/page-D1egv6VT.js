import{g as ee,s as v,j as s,r as K}from"./index-DMwWV6LZ.js";import{C as B,b as te,c as se,a as Q}from"./card-CZDdEFOl.js";import{u as $,q as E}from"./queryKeys-B8YbpHg6.js";import{u as H}from"./useMutation-rOajDVhN.js";import{B as V}from"./button-DdLPv1v6.js";import{S as oe,a as le,b as ce,c as de,d as me,T as ue,e as fe,f as he,g as W,h as be,i as Y}from"./table-BhjpBg1z.js";import{L as re,A as ye,a as ge}from"./alert-CjM6HumU.js";import{Z as pe}from"./zap-DI3uvbs9.js";import{c as ae}from"./createLucideIcon-De5o52GV.js";import{C as xe}from"./circle-alert-DaODrJr0.js";import{B as je}from"./badge-lPAdpJMK.js";import{m as Z}from"./proxy-BVDPlYaL.js";import{A as _e}from"./index-Bs2UPQaf.js";import{C as Se}from"./clock-BSwmNox5.js";import{C as J}from"./calendar-BEswqjrj.js";import"./index-Dy3eTchR.js";import"./index-CK0ERQAK.js";import"./index-B5rXH1kc.js";/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],Ee=ae("download",we);/**
 * @license lucide-react v0.544.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],Ne=ae("refresh-cw",Te),h=Object.freeze([]),G=Object.freeze(["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]),U=Object.freeze(["09:00","10:00","11:15","12:15","14:15","15:15"]),O=Object.freeze({classes:E?.classes?.all??["classes"],teachers:E?.teachers?.all??["teachers"],subjects:E?.subjects?.all??["subjects"],rooms:E?.rooms?.all??["rooms"],timeSlots:["time_slots"],generation:["timetable","generation"]});async function Ie(){const{data:e,error:t}=await v.from("classes").select("*");if(t)throw new Error(t.message||"Failed to load classes");return e??[]}async function Ce(){const{data:e,error:t}=await v.from("teacher_profile").select("*");if(t)throw new Error(t.message||"Failed to load teachers");return e??[]}async function ve(){const{data:e,error:t}=await v.from("subjects").select("*");if(t)throw new Error(t.message||"Failed to load subjects");return e??[]}async function Ae(){const{data:e,error:t}=await v.from("room").select("*");if(t)throw new Error(t.message||"Failed to load rooms");return e??[]}async function qe(){const{data:e,error:t}=await v.from("time_slots").select("*");if(t)throw new Error(t.message||"Failed to load time slots");return e??[]}function Fe(e=G,t=U){return function(i){const a={};return i&&i.student_timetables?i.student_timetables.forEach(n=>{const r=String(n.class_id);a[r]||(a[r]={}),n.timetable.forEach((l,c)=>{const u=e[c]??String(c);a[r][u]||(a[r][u]={}),l.forEach((b,y)=>{const f=t[y]??String(y);b.is_free||(a[r][u][f]={...b,class_id:r,day:u,start_time:f,type:"Theory"})})})}):i&&i.combined_view?i.combined_view.forEach(n=>{const r=e[n.day]??String(n.day),l=t[n.slot]??String(n.slot);n.assignments.forEach(c=>{const u=String(c.class_id);a[u]||(a[u]={}),a[u][r]||(a[u][r]={}),a[u][r][l]={...c,class_id:u,day:r,start_time:l,type:"Theory"}})}):Array.isArray(i)&&i.forEach(n=>{const r=String(n.class_id),l=n.day,c=n.start_time;a[r]||(a[r]={}),a[r][l]||(a[r][l]={}),a[r][l][c]=n}),a}}function Oe(e=G,t=U){return function({classes:i=h,teachers:a=h,subjects:n=h,rooms:r=h,timeSlots:l=h,subjectHours:c,subjectTeacherMap:u}={}){const b=a.map(o=>o?.name??"Unknown"),y=n.map(o=>o?.subject_name??"Subject"),f=i.map(o=>o?.class_name||`${o?.department||"Class"}-${o?.section||"A"}${o?.semester||""}`),j=r.map(o=>String(o?.room_number??o?.id??"")),S=Array.isArray(l)&&l.length>0?Array.from(new Set(l.map(o=>o.day))):e.slice(0,5).map((o,g)=>g),N=Array.isArray(l)&&l.length>0?l.filter(o=>o.day===l[0].day).length:Math.min(t.length,6);let m={};c&&typeof c=="object"?m=c:n.forEach((o,g)=>{const p=typeof o?.hours_per_week=="number"?o.hours_per_week:g%2===0?3:4;m[""+g]=parseInt(p,10)});let x={};if(u&&typeof u=="object")Object.entries(u).forEach(([o,g])=>{x[""+o]=Array.isArray(g)?g.map(p=>parseInt(p,10)).filter(p=>Number.isFinite(p)&&p>=0):[]});else{const o=new Map;a.forEach((g,p)=>{const I=g?.department??"__unknown__";o.has(I)||o.set(I,[]),o.get(I).push(p)}),n.forEach((g,p)=>{const I=g?.department??"__unknown__",k=o.get(I)??[],L=""+p;x[L]=k.length>0?k:[0]})}return{num_classes:parseInt(i.length,10)||1,days:S.length||5,slots_per_day:N||6,total_rooms:parseInt(r.length,10)||1,total_teachers:parseInt(a.length,10)||1,subject_hours:Object.fromEntries(Object.entries(m).map(([o,g])=>[""+o,g])),subject_teachers:Object.fromEntries(Object.entries(x).map(([o,g])=>[""+o,g])),subject_names:y,teacher_names:b,class_names:f.length>0?f:["Class A"],room_names:j}}}function ke({teachers:e=h,subjects:t=h,rooms:d=h}={}){return{getTeacherName:r=>r==null?"":e.find(c=>String(c?.id)===String(r))?.name??`Teacher ${r}`,getSubjectName:r=>r==null?"Free":t.find(c=>String(c?.id)===String(r))?.subject_name??`Subject ${r}`,getRoomNumber:r=>r==null?"":d.find(c=>String(c?.id)===String(r))?.room_number??`Room ${r}`}}function $e(e,t,d){const i={};if(!e||!e.student_timetables)return i;for(const a of e.student_timetables){const n=String(a.class_id);i[n]={};for(let r=0;r<t.length;r++){const l=t[r];i[n][l]={};for(let c=0;c<d.length;c++){const u=a.timetable[r]&&a.timetable[r][c]?a.timetable[r][c]:null;i[n][l][d[c]]=u}}}return i}function Le({days:e=G,times:t=U,endpointUrl:d="http://localhost:8000/generate-timetable/studentwise",classesQueryOptions:i={},teachersQueryOptions:a={},subjectsQueryOptions:n={},roomsQueryOptions:r={},timeSlotsQueryOptions:l={},generationOptions:c}={}){const u=ee(),b=$({queryKey:O.classes,queryFn:Ie,staleTime:6e4,...i}),y=$({queryKey:O.teachers,queryFn:Ce,staleTime:6e4,...a}),f=$({queryKey:O.subjects,queryFn:ve,staleTime:6e4,...n}),j=$({queryKey:O.rooms,queryFn:Ae,staleTime:6e4,...r}),S=$({queryKey:O.timeSlots,queryFn:qe,staleTime:10*6e4,...l}),N=!!(b.isLoading||y.isLoading||f.isLoading||j.isLoading||S.isLoading),m=!!(b.isError||y.isError||f.isError||j.isError||S.isError),x=b.error||y.error||f.error||j.error||S.error||null,o=async()=>{const[A,T,C,P,_]=await Promise.all([b.refetch(),y.refetch(),f.refetch(),j.refetch(),S.refetch()]);return{classes:A.data??h,teachers:T.data??h,subjects:C.data??h,rooms:P.data??h,timeSlots:_.data??h}},g=Fe(e,t),p=Oe(e,t),{getTeacherName:I,getSubjectName:k,getRoomNumber:L}=ke({teachers:y.data??h,subjects:f.data??h,rooms:j.data??h}),M=H({mutationKey:O.generation,mutationFn:async(A={})=>{const{payload:T,overrides:C,endpoint:P=d}=A;let _;if(T&&typeof T=="object")_=T;else{const F=p({classes:b.data??h,teachers:y.data??h,subjects:f.data??h,rooms:j.data??h,timeSlots:S.data??h});_=C?{...F,...C}:F}const w=await fetch(P,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(_)});if(!w.ok){let F=`Backend error: ${w.status}`;try{F=await w.text()||F}catch{}throw new Error(F)}const q=await w.json(),D=$e(q,e,t);return{raw:q,organized:D}},onSuccess:async(A,T,C)=>{await Promise.all([u.invalidateQueries({queryKey:O.timeSlots})]),c?.onSuccess&&c.onSuccess(...arguments)},onError:(A,T,C)=>{c?.onError&&c.onError(A,T,C)},...c});return{data:{classes:b.data??h,teachers:y.data??h,subjects:f.data??h,rooms:j.data??h,timeSlots:S.data??h},queries:{classesQuery:b,teachersQuery:y,subjectsQuery:f,roomsQuery:j,timeSlotsQuery:S},isLoading:N,isError:m,error:x,refetchAll:o,assemblePayload:p,organizeTimetable:g,getTeacherName:I,getSubjectName:k,getRoomNumber:L,generate:M.mutate,generateAsync:M.mutateAsync,generationStatus:M}}function Me({title:e,subtitle:t,children:d,className:i=""}){return s.jsxs("header",{className:`flex flex-col md:flex-row justify-between items-start md:items-center gap-4 ${i}`,"aria-labelledby":"page-title",children:[s.jsxs("div",{children:[e?s.jsx("h1",{id:"page-title",className:"text-3xl font-bold text-slate-900",children:e}):null,t?s.jsx("p",{className:"text-slate-600 mt-1",children:t}):null]}),d?s.jsx("div",{className:"flex items-center gap-2",children:d}):null]})}function Pe({classes:e=[],selectedClass:t,onSelectClass:d,onGenerate:i,generating:a=!1,onExport:n,errorMessage:r="",title:l="Timetable Generator",disableGenerate:c=!1,disableExport:u=!1}){const b=!a&&!!t&&!c,y=!!t&&!u;return s.jsxs(B,{children:[s.jsx(te,{children:s.jsxs(se,{className:"flex items-center gap-2",children:[s.jsx(pe,{className:"w-5 h-5 text-indigo-600"}),l]})}),s.jsxs(Q,{className:"space-y-4",children:[s.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[s.jsx("div",{className:"flex-1",children:s.jsxs(oe,{value:t??"",onValueChange:d,children:[s.jsx(le,{"aria-label":"Select class",children:s.jsx(ce,{placeholder:"Select a class..."})}),s.jsx(de,{children:e.map(f=>s.jsxs(me,{value:String(f.id),children:[f.class_name,f.semester?`(Sem ${f.semester})`:""]},f.id))})]})}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(V,{onClick:i,disabled:!b,className:"bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700",children:a?s.jsxs(s.Fragment,{children:[s.jsx(re,{className:"w-4 h-4 mr-2 animate-spin"}),"Generating..."]}):s.jsxs(s.Fragment,{children:[s.jsx(Ne,{className:"w-4 h-4 mr-2"}),"Generate Timetable"]})}),s.jsxs(V,{variant:"outline",disabled:!y,onClick:n,children:[s.jsx(Ee,{className:"w-4 h-4 mr-2"}),"Export"]})]})]}),r?s.jsxs(ye,{variant:"destructive",role:"alert",children:[s.jsx(xe,{className:"h-4 w-4"}),s.jsx(ge,{children:String(r)})]}):null]})]})}function Re({days:e,times:t,getSlotData:d,getSubjectName:i,getTeacherName:a,getRoomNumber:n,className:r="",animate:l=!0,showFreeLabel:c=!0,freeLabel:u="Free",onCellClick:b,renderSlot:y}){const f=l?Z.tr:"tr",j=(m,x,o)=>{typeof b=="function"&&b({day:m,time:x,slot:o})},S=typeof b=="function",N=m=>m?s.jsxs(Z.div,{initial:l?{scale:.95,opacity:0}:!1,animate:l?{scale:1,opacity:1}:!1,className:"bg-gradient-to-br from-blue-50 to-blue-100 p-3 rounded-lg border border-blue-200 text-left",children:[s.jsx("div",{className:"font-semibold text-blue-900 text-sm",children:i?.(m.subject_id)??String(m.subject_id??"")}),s.jsx("div",{className:"text-xs text-blue-600 mt-1",children:a?.(m.teacher_id)??String(m.teacher_id??"")}),s.jsx("div",{className:"text-xs text-blue-500 mt-1",children:n?n(m.room_id):`Room: ${String(m.room_id??"")}`}),m.type?s.jsx(je,{variant:"outline",className:"bg-blue-200 text-blue-800 border-blue-300 text-xs mt-1",children:m.type}):null]}):null;return s.jsxs(ue,{className:r,children:[s.jsx(fe,{children:s.jsxs(he,{children:[s.jsx(W,{className:"w-24",children:"Time"}),e.map(m=>s.jsx(W,{className:"text-center min-w-[150px]",children:m},m))]})}),s.jsx(be,{children:s.jsx(_e,{initial:!1,children:t.map(m=>s.jsxs(f,{initial:l?{opacity:0}:!1,animate:l?{opacity:1}:!1,exit:l?{opacity:0}:!1,children:[s.jsx(Y,{className:"font-medium bg-slate-50",children:s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(Se,{className:"w-3 h-3 text-slate-400"}),m]})}),e.map(x=>{const o=d?.(x,m)??null,g=S?{onClick:()=>j(x,m,o),className:"p-2 text-center cursor-pointer hover:bg-slate-50 transition-colors",role:"button",tabIndex:0,onKeyDown:p=>{(p.key==="Enter"||p.key===" ")&&(p.preventDefault(),j(x,m,o))},"aria-label":o?`Slot: ${i?.(o.subject_id)??"Subject"} at ${m} on ${x}`:`Free slot at ${m} on ${x}`}:{className:"p-2 text-center"};return s.jsx(Y,{...g,children:o?y?y({slot:o,day:x,time:m}):N(o):s.jsx("div",{className:"p-3 rounded-lg border border-dashed border-slate-200 text-slate-400",children:c?u:null})},x)})]},m))})})]})}const z=["Monday","Tuesday","Wednesday","Thursday","Friday"],X=["09:00","10:00","11:15","12:15","14:15","15:15"],ze=Object.freeze([]);async function De({filters:e={},includeTimeSlot:t=!0}={}){const d="id, class_id, time_slot_id, subject_id, teacher_id, room_id, type, created_at",i=t?`${d}, time_slots:time_slot_id(id, day, start_time, end_time)`:d;console.log(i);let a=v.from("timetable_entries").select(i);e.classId!==void 0&&e.classId!==null&&(a=a.eq("class_id",e.classId)),e.teacherId!==void 0&&e.teacherId!==null&&(a=a.eq("teacher_id",e.teacherId)),e.roomId!==void 0&&e.roomId!==null&&(a=a.eq("room_id",e.roomId)),e.timeSlotId!==void 0&&e.timeSlotId!==null&&(a=a.eq("time_slot_id",e.timeSlotId)),e.subjectId!==void 0&&e.subjectId!==null&&(a=a.eq("subject_id",e.subjectId)),a=a.order("time_slot_id",{ascending:!0}).order("created_at",{ascending:!0});const{data:n,error:r}=await a;if(r)throw new Error(r.message||"Failed to load timetable entries");return n??[]}function Ke(e={},t=!0){const d=Object.entries(e).filter(([,n])=>n!=null),i=d.length===1?d[0][0]:null;if(i==="classId")return E.timetableEntries.byClass(e.classId);if(i==="teacherId")return E.timetableEntries.byTeacher(e.teacherId);if(i==="roomId")return E.timetableEntries.byRoom(e.roomId);if(i==="timeSlotId")return E.timetableEntries.byTimeSlot(e.timeSlotId);const a=Object.fromEntries(Object.entries(e).filter(([,n])=>n!=null).map(([n,r])=>[n,String(r)]));return[...E.timetableEntries.list(),{...a,includeTimeSlot:t}]}function Be(e={}){const{filters:t={},includeTimeSlot:d=!0,queryOptions:i={}}=e,a=Ke(t,d),n=$({queryKey:a,queryFn:()=>De({filters:t,includeTimeSlot:d}),staleTime:6e4,...i});return{entries:n.data??ze,isLoading:n.isLoading,isError:n.isError,error:n.error??null,refetch:n.refetch,query:n}}function Qe(e,t={}){return Be({filters:{classId:e},includeTimeSlot:t.includeTimeSlot??!0,queryOptions:{enabled:!!e,...t.queryOptions||{}}})}function ne(e){if(!e)return e;const t=String(e);return t.length>=5&&t[2]===":"?t.slice(0,5):t}function He(e){const t=new Map;for(const d of e||[]){const i=`${d.day}::${ne(d.start_time)}`;t.set(i,d.id)}return t}function Ge(e,t){return t&&Object.prototype.hasOwnProperty.call(t,e)?t[e]:/^\d+$/.test(String(e))?Number(e):e}function ie({organized:e,days:t,timeSlots:d,classKeyToId:i}){if(!e||typeof e!="object")return[];const a=new Map((t||[]).map((l,c)=>[String(l).toLowerCase(),c])),n=He(d||[]),r=[];for(const[l,c]of Object.entries(e)){const u=Ge(l,i);for(const[b,y]of Object.entries(c||{})){const f=a.get(String(b).toLowerCase());if(f!==void 0)for(const[j,S]of Object.entries(y||{})){if(!S)continue;const N=ne(j),m=n.get(`${f}::${N}`);if(!m)continue;const{subject_id:x,teacher_id:o,room_id:g,type:p="Theory"}=S;x===void 0||o===void 0||g===void 0||r.push({class_id:u,time_slot_id:m,subject_id:x,teacher_id:o,room_id:g,type:p})}}}return r}async function Ue(e){const{rows:t,organized:d,days:i,timeSlots:a,classKeyToId:n,mode:r="upsert"}=e||{},l=t&&t.length?t:d?ie({organized:d,days:i||[],timeSlots:a||[],classKeyToId:n}):[];if(!l.length)return{data:[],error:null};const c=Array.from(new Set(l.map(f=>f.class_id)));if(r==="replace"&&c.length){const{error:f}=await v.from("timetable_entries").delete().in("class_id",c);if(f)throw new Error(f.message||"Failed to clear existing timetable entries")}let u=v.from("timetable_entries");r==="upsert"?u=u.upsert(l,{onConflict:"class_id,time_slot_id"}):u=u.insert(l);const{data:b,error:y}=await u.select();if(y)throw new Error(y.message||"Failed to insert timetable entries");return{data:b,error:null}}async function Ve({classIds:e}){const t=Array.isArray(e)?e.filter(a=>a!=null):[];if(!t.length)return{data:[],error:null};const{data:d,error:i}=await v.from("timetable_entries").delete().in("class_id",t).select();if(i)throw new Error(i.message||"Failed to clear class timetable entries");return{data:d,error:null}}function We(){const e=ee(),t=H({mutationKey:[...E.timetableEntries.all,"insert"],mutationFn:Ue,onSuccess:async()=>{await e.invalidateQueries({queryKey:E.timetableEntries.all})}}),d=H({mutationKey:[...E.timetableEntries.all,"clearByClass"],mutationFn:Ve,onSuccess:async()=>{await e.invalidateQueries({queryKey:E.timetableEntries.all})}});return{insertEntries:t,insertEntriesAsync:n=>t.mutateAsync(n),clearClassEntries:d,clearClassEntriesAsync:n=>d.mutateAsync(n),mapOrganizedToRows:ie}}function ht(){const[e,t]=K.useState(""),[d,i]=K.useState({}),[a,n]=K.useState(""),{data:{classes:r,teachers:l,subjects:c,rooms:u,timeSlots:b},isLoading:y,isError:f,error:j,assemblePayload:S,getTeacherName:N,getSubjectName:m,getRoomNumber:x,generateAsync:o,generationStatus:g}=Le({days:z,times:X}),{mapOrganizedToRows:p,insertEntriesAsync:I,insertEntries:k}=We(),{entries:L,refetch:M}=Qe(e,{includeTimeSlot:!1,queryOptions:{enabled:!!e}}),A=g.isPending||k.isPending,T=_=>{if(!_)return _;const w=String(_);return w.length>=5&&w[2]===":"?w.slice(0,5):w},C=async()=>{if(!e){n("Please select a class first");return}n("");try{const _=S({classes:r,teachers:l,subjects:c,rooms:u,timeSlots:b}),{organized:w}=await o({payload:_}),q=p({organized:w,days:z,timeSlots:b});await I({rows:q,mode:"upsert"}),i(w),await M()}catch(_){console.error("Timetable generation error:",_),n(`Error generating timetable: ${_.message}`)}},P=(_,w)=>{const q=z.indexOf(_);if(q===-1)return null;const D=T(w);return(L||[]).find(R=>R?.time_slots?.day===q&&T(R?.time_slots?.start_time)===D&&String(R?.class_id)===String(e))||null};return y?s.jsx("div",{className:"p-6 flex items-center justify-center",style:{minHeight:400},role:"status","aria-live":"polite","aria-busy":"true",children:s.jsxs("div",{className:"flex items-center gap-2 text-slate-700",children:[s.jsx(re,{className:"animate-spin text-slate-600",style:{width:24,height:24},"aria-hidden":"true"}),s.jsx("span",{children:"Loading timetable data..."})]})}):s.jsxs("div",{className:"p-6 space-y-6",children:[s.jsx(Me,{title:"Timetable Generator",subtitle:"Generate and view individual class schedules"}),s.jsx(Pe,{classes:r,selectedClass:e,onSelectClass:t,onGenerate:C,generating:A,errorMessage:a||(f&&j?String(j?.message||j):"")}),e?s.jsxs(B,{children:[s.jsx(te,{children:s.jsxs(se,{className:"flex items-center gap-2",children:[s.jsx(J,{className:"w-5 h-5"}),"Weekly Timetable â€“",r.find(_=>String(_.id)===e)?.name]})}),s.jsx(Q,{children:s.jsx("div",{className:"overflow-x-auto",children:s.jsx(Re,{days:z,times:X,getSlotData:P,getSubjectName:m,getTeacherName:N,getRoomNumber:x})})})]}):s.jsx(B,{role:"region","aria-label":"Empty state",children:s.jsxs(Q,{className:"p-8 text-center",children:[s.jsx(J,{className:"w-16 h-16 text-slate-300 mx-auto mb-4","aria-hidden":"true"}),s.jsx("h3",{className:"text-lg font-medium text-slate-900 mb-2",children:"No Class Selected"}),s.jsx("p",{className:"text-slate-500 mb-4",children:"Please select a class to view or generate its timetable."})]})})]})}export{ht as default};
