import{r as w,j as e,g as re,s as v,y as E}from"./index-DMwWV6LZ.js";import{I as he}from"./input-D6FpiF2T.js";import{C as ae,a as te,b as je,c as xe}from"./card-CZDdEFOl.js";import{S as U,a as P,b as R,c as K,d as L,T as fe,e as ye,f as H,g as pe,h as be,i as B}from"./table-BhjpBg1z.js";import{u as ne}from"./useSubjects-BUb3Sea-.js";import{S as we,F as Se,r as ge,u as J,C as V,a as Ne}from"./readXlsxFileBrowser-B_cWmW9H.js";import{u as q}from"./useMutation-rOajDVhN.js";import{q as b,u as Te}from"./queryKeys-B8YbpHg6.js";import{B as X}from"./badge-lPAdpJMK.js";import{B as _}from"./button-DdLPv1v6.js";import{L as Ee,A as ve,a as Ce,C as Z}from"./alert-CjM6HumU.js";import{u as ce}from"./useTeachers-BwAFSO2X.js";import{C as ke}from"./circle-alert-DaODrJr0.js";import{U as _e}from"./users-BpObsUQF.js";import{P as Ae}from"./plus-DJfzYg-M.js";import{A as qe}from"./index-Bs2UPQaf.js";import{m as O}from"./proxy-BVDPlYaL.js";import{X as ee}from"./x-DXQQL3e4.js";import{M as Fe}from"./mail-Ct3AERel.js";import{T as Ie}from"./trash-2-CGwPMucJ.js";import"./index-Dy3eTchR.js";import"./index-CK0ERQAK.js";import"./index-B5rXH1kc.js";import"./createLucideIcon-De5o52GV.js";function De({onSearchChange:s,onSubjectChange:a}){const{subjects:r}=ne(),[i,d]=w.useState(""),[h,j]=w.useState("all"),o=n=>{const c=n.target.value;d(c),s(c)},m=n=>{j(n),a(n==="all"?null:n)};return e.jsx(ae,{children:e.jsx(te,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(we,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(he,{placeholder:"Search teachers...",value:i,onChange:o,className:"pl-10"})]}),e.jsxs(U,{value:h,onValueChange:m,children:[e.jsx(P,{className:"w-[200px]",children:e.jsx(R,{placeholder:"All Subjects"})}),e.jsxs(K,{children:[e.jsx(L,{value:"all",children:"All Subjects"}),r.map(n=>e.jsx(L,{value:n.subject_name,children:n.subject_name},n.subject_name))]})]})]})})})}async function Le(s){if(!s||typeof s!="object"||Array.isArray(s))throw new Error("Invalid teacher payload");if(!s.email)throw new Error("Teacher must include an email");const{data:a,error:r}=await v.functions.invoke("teacher-creation",{body:s});if(r)throw console.error("Edge function error:",r),new Error(r.message||"Failed to create teacher");return a}async function Me({id:s,updates:a}){const{data:r,error:i}=await v.from("teacher_profile").update(a).eq("id",s).select("*").single();if(i)throw new Error(i.message||"Failed to update teacher");return r}async function Qe(s){const{error:a}=await v.from("teacher_profile").delete().eq("id",s);if(a)throw new Error(a.message||"Failed to delete teacher");return{id:s}}function Y({createOptions:s,updateOptions:a,deleteOptions:r}={}){const i=re(),d=q({mutationFn:Le,onSuccess:async(o,m,n)=>{i.setQueryData(b.teachers.all,c=>{const u=Array.isArray(c)?c:[];return[o,...u]}),await i.invalidateQueries({queryKey:b.teachers.all}),s?.onSuccess&&s.onSuccess(o,m,n)},onError:(o,m,n)=>{s?.onError&&s.onError(o,m,n)},...s}),h=q({mutationFn:Me,onSuccess:async(o,m,n)=>{i.setQueryData(b.teachers.all,c=>Array.isArray(c)?c.map(u=>u?.id===o?.id?{...u,...o}:u):c),await i.invalidateQueries({queryKey:b.teachers.all}),a?.onSuccess&&a.onSuccess(o,m,n)},onError:(o,m,n)=>{a?.onError&&a.onError(o,m,n)},...a}),j=q({mutationFn:Qe,onSuccess:async(o,m,n)=>{const c=o?.id??m;i.setQueryData(b.teachers.all,u=>Array.isArray(u)?u.filter(S=>S?.id!==c):u),await i.invalidateQueries({queryKey:b.teachers.all}),r?.onSuccess&&r.onSuccess(o,m,n)},onError:(o,m,n)=>{r?.onError&&r.onError(o,m,n)},...r});return{createTeacher:d.mutate,createTeacherAsync:d.mutateAsync,updateTeacher:h.mutate,updateTeacherAsync:h.mutateAsync,deleteTeacher:j.mutate,deleteTeacherAsync:j.mutateAsync,createStatus:d,updateStatus:h,deleteStatus:j}}const se=["Professor","Associate Professor","Assistant Professor","Lecturer","Senior Lecturer"],$e=["name","email","emp_id","subjects","designation","max_hours"],D=[{key:"name",label:"Name",width:"w-[20%]"},{key:"emp_id",label:"Employee ID",width:"w-[10%]"},{key:"subjects",label:"Subjects",width:"w-[15%]"},{key:"designation",label:"Designation",width:"w-[15%]"},{key:"email",label:"Email",width:"w-[20%]"},{key:"max_hours",label:"Max Hours",width:"w-[10%]"},{key:"actions",label:"",width:"w-[10%]"}];function Be({}){const{createTeacherAsync:s,updateTeacherAsync:a}=Y(),{teachers:r}=ce(),[i,d]=w.useState(""),[h,j]=w.useState(!1),o=async m=>{const n=m.target.files[0];if(n){j(!0),d("");try{const c=await ge(n),S=c[0].map(f=>f&&typeof f=="string"?f?.toLowerCase():""),F=$e.filter(f=>!S?.includes(f?.toLowerCase()));if(F.length>0){d(`Missing columns: ${F.join(", ")}`),j(!1);return}const N={};S.forEach((f,x)=>{N[f]=x});const M=[],C=[];for(let f=1;f<c.length;f++){const x=c[f];if(x.every(k=>k===null||k===""))continue;const p={name:x[N.name]||"",email:x[N.email]||"",emp_id:String(x[N.emp_id]||""),department:x[N.department]||"",designation:x[N.designation]||"",max_hours:parseInt(x[N.max_hours])||20,subjects:[]};if(!p?.name||!p?.email||!p?.emp_id)continue;const $=r.find(k=>k?.emp_id===p?.emp_id||k?.email?.toLowerCase()===p?.email?.toLowerCase());$?C.push({id:$.id,updates:p}):M.push(p)}if(M.length===0&&C.length===0){d("No valid teacher data found in the file"),j(!1);return}let z=0,Q=0,A=[];for(const f of M)try{await s(f),z++}catch(x){A.push(`Add error for ${f.name}: ${x.message}`)}for(const{id:f,updates:x}of C)try{await a({id:f,updates:x}),Q++}catch(p){A.push(`Update error for ${x.name}: ${p.message}`)}A.length>0?d(A.join(`
`)):(E.success(`Successfully imported ${z} new teachers and updated ${Q} existing teachers.`),m.target.value=null)}catch(c){d(`Error processing file: ${c.message}`)}j(!1)}};return e.jsxs("div",{children:[e.jsx(_,{variant:"outline",onClick:()=>document.getElementById("excelFileInput").click(),className:"border-blue-300 hover:bg-blue-50",disabled:h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(Ee,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"w-4 h-4 mr-2"}),"Import Excel"]})}),e.jsx("input",{id:"excelFileInput",type:"file",className:"hidden",accept:".xlsx",onChange:o,disabled:h}),i&&e.jsxs(ve,{variant:"destructive",className:"mt-4",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(Ce,{children:i})]})]})}const Ue=Object.freeze([]);async function Pe(){const{data:s,error:a}=await v.from("teacher_subjects").select("*");if(a)throw new Error(a.message||"Failed to load teacher subjects");return s??[]}function ie(s={}){const{teachersSubjectQueryOptions:a={}}=s,r=Te({queryKey:b.teacherSubjects.all,queryFn:Pe,staleTime:10*6e4,...a}),i=!!r.isLoading,d=!!r.isError,h=r.error??null,j=async()=>{const[o]=await Promise.all([r.refetch()]);return{teacherSubjects:o.data??[]}};return{teacherSubjects:r.data??Ue,isLoading:i,isError:d,error:h,refetch:j,teachersSubjectQuery:r}}async function Re(s){const{data:a,error:r}=await v.from("teacher_subjects").insert([s]).select("*").single();if(r)throw new Error(r.message||"Failed to link teacher with subject");return a}async function Ke({teacher:s,subject:a}){const{data:r,error:i}=await v.from("teacher_subjects").update({subject:a}).eq("teacher",s).select("*").single();if(i)throw new Error(i.message||"Failed to update teacher");return r}async function ze({teacher:s,subject:a}){const{error:r}=await v.from("teacher_subjects").delete().eq("teacher",s).eq("subject",a);if(r)throw new Error(r.message||"Failed to unlink teacher from subject");return{teacher:s,subject:a}}async function Ve({teacher:s,subject:a}){const{error:r}=await v.from("teacher_subjects").delete().eq("teacher",s);if(r)throw new Error(r.message||"Failed to reset teacher subjects");if(!a||a.length===0)return[];const{data:i,error:d}=await v.from("teacher_subjects").insert(a.map(h=>({teacher:s,subject:h}))).select("*");if(d)throw new Error(d.message||"Failed to insert teacher subjects");return i}function He({createOptions:s,editingOptions:a,deleteOptions:r,bulkReplaceOptions:i}={}){const d=re(),h=q({mutationFn:Re,onSuccess:async(n,c,u)=>{d.invalidateQueries({queryKey:b.teacherSubjects.all}),s?.onSuccess&&s.onSuccess(n,c,u)},onError:(n,c,u)=>{s?.onError&&s.onError(n,c,u)},...s}),j=q({mutationFn:Ke,onSuccess:async(n,c,u)=>{d.invalidateQueries({queryKey:b.teacherSubjects.all}),a?.onSuccess&&a.onSuccess(n,c,u)},onError:(n,c,u)=>{a?.onError&&a.onError(n,c,u)},...a}),o=q({mutationFn:ze,onSuccess:async(n,c,u)=>{d.invalidateQueries({queryKey:b.teacherSubjects.all}),r?.onSuccess&&r.onSuccess(n,c,u)},onError:(n,c,u)=>{r?.onError&&r.onError(n,c,u)},...r}),m=q({mutationFn:Ve,onSuccess:async(n,c,u)=>{d.invalidateQueries({queryKey:b.teacherSubjects.all}),i?.onSuccess&&i.onSuccess(n,c,u)},onError:(n,c,u)=>{i?.onError&&i.onError(n,c,u)},...i});return{createTeacherSubject:h.mutate,createTeacherSubjectAsync:h.mutateAsync,editTeacherSubject:j.mutate,editTeacherSubjectAsync:j.mutateAsync,deleteTeacherSubject:o.mutate,deleteTeacherSubjectAsync:o.mutateAsync,bulkReplaceTeacherSubjects:m.mutate,bulkReplaceTeacherSubjectsAsync:m.mutateAsync,createStatus:h,editStatus:j,deleteStatus:o,bulkReplaceStatus:m}}function Xe({filteredTeacher:s}){const{deleteTeacherAsync:a,createTeacherAsync:r,updateTeacherAsync:i}=Y(),[d,h]=w.useState(null),[j,o]=w.useState(!1),[m,n]=w.useState(null),{teacherSubjects:c,isLoading:u}=ie(),{subjects:S}=ne(),{createTeacherSubjectAsync:F,deleteTeacherSubjectAsync:N,editTeacherSubjectAsync:M}=He(),{register:C,handleSubmit:z,reset:Q,control:A,formState:{errors:f}}=J(),{register:x,handleSubmit:p,reset:$,control:k,setValue:I,formState:{errors:le}}=J(),oe=async t=>{if(!confirm(`Delete teacher "${t.name}"?`))return;const y=c.find(l=>l.teacher===t.name);y&&await N({teacher:t.name,subject:y.subject}),await a(t.id)},ue=t=>{n(t.id),I("name",t.name),I("emp_id",t.emp_id),I("subjects",t.subjects||[]),I("designation",t.designation),I("email",t.email),I("max_hours",t.max_hours)},de=async t=>{const{subjects:y,...l}=t;f&&E.error("Please fill all required fields correctly."),await r(l),await F({teacher:t.name,subject:y}),Q(),o(!1)},me=async t=>{le&&E.error("Please fill all required fields correctly.");const{subjects:y,...l}=t;await i({id:m,updates:l}),await M({teacher:t.name,subject:y}),n(null),$()},G=({onClick:t})=>e.jsx(_,{size:"sm",variant:"outline",onClick:t,children:e.jsx(Ne,{className:"w-3 h-3"})}),W=({onClick:t})=>e.jsx(_,{size:"sm",variant:"outline",onClick:t,className:"text-red-600 hover:text-red-700",children:e.jsx(Ie,{className:"w-3 h-3"})});return e.jsxs(ae,{children:[e.jsx(je,{children:e.jsxs(xe,{className:"flex items-center gap-2",children:[e.jsx(_e,{className:"w-5 h-5"}),"Teachers (",s.length,")",e.jsxs("div",{className:"flex gap-2 ml-auto",children:[e.jsxs(_,{className:"bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700",onClick:()=>o(!0),children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Add Teacher"]}),e.jsx(Be,{teachers:s})]})]})}),e.jsx(te,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(fe,{className:"table-fixed w-full",children:[e.jsx(ye,{children:e.jsx(H,{children:D.map(t=>e.jsx(pe,{className:t.width,children:t.label},t.key))})}),e.jsx(be,{children:e.jsxs(qe,{children:[u?e.jsx(H,{children:e.jsx(B,{colSpan:D.length,className:"text-center py-8",children:"Loading teachers..."})}):s.length===0?e.jsx(H,{children:e.jsx(B,{colSpan:D.length,className:"text-center py-8",children:"No teachers found"})}):s.map((t,y)=>e.jsx(O.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:y*.05},className:"hover:bg-slate-50",onMouseEnter:()=>h(t.id),onMouseLeave:()=>h(null),children:m===t.id?D.map(l=>e.jsxs(B,{children:[l.key==="name"&&e.jsx("input",{...x("name",{required:!0}),className:"w-full border px-2 py-1 rounded"}),l.key==="emp_id"&&e.jsx("input",{...x("emp_id",{required:!0}),className:"w-full border px-2 py-1 rounded"}),l.key==="subjects"&&e.jsx(V,{name:"subjects",control:k,rules:{required:!0},render:({field:T})=>e.jsxs(U,{value:T.value,onValueChange:T.onChange,children:[e.jsx(P,{className:"w-full",children:e.jsx(R,{placeholder:"Select Subject"})}),e.jsx(K,{children:S.map(g=>e.jsx(L,{value:g.subject_name,children:e.jsx(X,{variant:"outline",className:"border-slate-200 text-slate-500",children:g.subject_name},g.subject_name)},g.subject_name))})]})}),l.key==="designation"&&e.jsx(V,{name:"designation",control:k,rules:{required:!0},render:({field:T})=>e.jsxs(U,{value:T.value,onValueChange:T.onChange,children:[e.jsx(P,{className:"w-full",children:e.jsx(R,{placeholder:"Designation"})}),e.jsx(K,{children:se.map(g=>e.jsx(L,{value:g,children:g},g))})]})}),l.key==="email"&&e.jsx("input",{type:"email",...x("email",{required:!0}),className:"w-full border px-2 py-1 rounded"}),l.key==="max_hours"&&e.jsx("input",{type:"number",...x("max_hours",{required:!0}),className:"w-full border px-2 py-1 rounded"}),l.key==="actions"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{size:"sm",variant:"outline",onClick:()=>{n(null),$()},children:e.jsx(ee,{className:"w-3 h-3"})}),e.jsx(_,{size:"sm",className:"bg-blue-500 text-white",onClick:p(me),children:e.jsx(Z,{className:"w-3 h-3"})})]})]},l.key)):D.map(l=>e.jsxs(B,{children:[l.key==="name"&&e.jsx("div",{className:"font-medium",children:t.name}),l.key==="emp_id"&&t.emp_id,l.key==="subjects"&&e.jsx("div",{className:"flex flex-wrap gap-1",children:c.filter(T=>t.name===T.teacher).map((T,g)=>e.jsx(X,{variant:"outline",className:"border-slate-200 text-slate-500",children:T.subject},g))}),l.key==="designation"&&t.designation,l.key==="email"&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Fe,{className:"w-3 h-3 text-slate-400"}),t.email]}),l.key==="max_hours"&&`${t.max_hours} hrs`,l.key==="actions"&&e.jsx("div",{className:"flex gap-2",children:d===t.id?e.jsxs(e.Fragment,{children:[e.jsx(G,{onClick:()=>ue(t)}),e.jsx(W,{onClick:()=>oe(t)})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{visibility:"hidden"},children:e.jsx(G,{})}),e.jsx("span",{style:{visibility:"hidden"},children:e.jsx(W,{})})]})})]},l.key))},t.id)),j&&e.jsx(O.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},children:D.map(t=>e.jsxs(B,{children:[t.key==="name"&&e.jsx("input",{type:"text",placeholder:"Name",className:"w-full border px-2 py-1 rounded",...C("name",{required:!0})}),t.key==="emp_id"&&e.jsx("input",{type:"text",placeholder:"Employee ID",className:"w-full border px-2 py-1 rounded",...C("emp_id",{required:!0})}),t.key==="subjects"&&e.jsx(V,{name:"subjects",control:A,rules:{required:!0},render:({field:y})=>e.jsxs(U,{value:y.value,onValueChange:y.onChange,children:[e.jsx(P,{className:"w-full",children:e.jsx(R,{placeholder:"Subject"})}),e.jsx(K,{children:S.map(l=>e.jsx(L,{value:l.subject_name,children:e.jsx(X,{variant:"outline",className:"border-slate-200 text-slate-500",children:l.subject_name},l.subject_name)},l.subject_name))})]})}),t.key==="designation"&&e.jsx(V,{name:"designation",control:A,rules:{required:!0},render:({field:y})=>e.jsxs(U,{value:y.value,onValueChange:y.onChange,children:[e.jsx(P,{className:"w-full",children:e.jsx(R,{placeholder:"Designation"})}),e.jsx(K,{children:se.map(l=>e.jsx(L,{value:l,children:l},l))})]})}),t.key==="email"&&e.jsx("input",{type:"email",placeholder:"Email",className:"w-full border px-2 py-1 rounded",...C("email",{required:!0,pattern:/^\S+@\S+$/i})}),t.key==="max_hours"&&e.jsx("input",{placeholder:"Max Hours",className:"w-full border px-2 py-1 rounded",...C("max_hours",{required:!0,min:1,max:40})}),t.key==="actions"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{size:"sm",variant:"outline",onClick:()=>{Q(),o(!1)},children:e.jsx(ee,{className:"w-3 h-3"})}),e.jsx(_,{size:"sm",className:"bg-blue-500 text-white",onClick:z(de),children:e.jsx(Z,{className:"w-3 h-3"})})]})]},t.key))},"new-row")]})})]})})})]})}function Ye({createStatus:s,updateStatus:a,deleteStatus:r}){w.useEffect(()=>{s.isSuccess&&E.success("Teacher created successfully!"),a.isSuccess&&E.success("Teacher updated successfully!"),r.isSuccess&&E.success("Teacher deleted successfully!"),s.isError&&E.error(`Create failed: ${s.error.message}`),a.isError&&E.error(`Update failed: ${a.error.message}`),r.isError&&E.error(`Delete failed: ${r.error.message}`)},[s,a,r])}function Ge(s,a,r){return w.useMemo(()=>s?.filter(i=>{const d=i.name?.toLowerCase()?.includes(a?.toLowerCase()),h=!r||i?.subject===r;return d&&h}),[s,a,r])}function ws(){const{teachers:s}=ce(),{teacherSubjects:a}=ie(),r=s.map(u=>{const S=a.find(F=>F.teacher===u.name);return{...u,subject:S?S.subject:"Unknown"}}),{createStatus:i,updateStatus:d,deleteStatus:h}=Y(),[j,o]=w.useState(""),[m,n]=w.useState(null);Ye({createStatus:i,updateStatus:d,deleteStatus:h});const c=Ge(r,j,m);return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-slate-900",children:"Teachers Management"}),e.jsx("p",{className:"text-slate-600 mt-1",children:"Manage faculty members and their details"})]})}),e.jsx(De,{onSearchChange:o,onSubjectChange:n}),e.jsx(Xe,{filteredTeacher:c})]})}export{ws as default};
