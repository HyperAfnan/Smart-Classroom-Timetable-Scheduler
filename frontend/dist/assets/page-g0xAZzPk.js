import{r as S,j as e,g as ce,s as V,y as ie}from"./index-DMwWV6LZ.js";import{u as K}from"./useSubjects-BUb3Sea-.js";import{C as ee,a as se,b as oe,c as ue}from"./card-CZDdEFOl.js";import{I as de}from"./input-D6FpiF2T.js";import{S as D,a as z,b as B,c as M,d as A,T as me,e as he,f as P,g as pe,h as je,i as F}from"./table-BhjpBg1z.js";import{S as xe,F as ye,r as be,u as J,C as R,a as X}from"./readXlsxFileBrowser-B_cWmW9H.js";import{B as g}from"./button-DdLPv1v6.js";import{B as T}from"./badge-lPAdpJMK.js";import{u as fe}from"./useTeachers-BwAFSO2X.js";import{u as Q}from"./useMutation-rOajDVhN.js";import{q as E}from"./queryKeys-B8YbpHg6.js";import{L as we,A as ge,a as Se,C as Y}from"./alert-CjM6HumU.js";import{C as Ne}from"./circle-alert-DaODrJr0.js";import{B as Ce}from"./book-open-DtpCj_Lg.js";import{P as ke}from"./plus-DJfzYg-M.js";import{A as _e}from"./index-Bs2UPQaf.js";import{m as W}from"./proxy-BVDPlYaL.js";import{X as G}from"./x-DXQQL3e4.js";import{M as ve}from"./mail-Ct3AERel.js";import{C as Te}from"./clock-BSwmNox5.js";import{T as Z}from"./trash-2-CGwPMucJ.js";import"./index-Dy3eTchR.js";import"./index-CK0ERQAK.js";import"./index-B5rXH1kc.js";import"./createLucideIcon-De5o52GV.js";function Ee({departments:t,searchTerm:r,selectedDepartment:c,onSearchChange:i,onDepartmentChange:n}){const[x,m]=S.useState(r),[a,u]=S.useState(c||"all"),d=h=>{const f=h.target.value;m(f),i(f)},o=h=>{u(h),n(h)};return e.jsx(ee,{children:e.jsx(se,{className:"p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"}),e.jsx(de,{placeholder:"Search subjects...",value:x,onChange:d,className:"pl-10"})]}),e.jsxs(D,{value:a,onValueChange:o,children:[e.jsx(z,{className:"w-[200px]",children:e.jsx(B,{placeholder:"All Departments"})}),e.jsxs(M,{children:[e.jsx(A,{value:"all",children:"All Departments"}),t.map(h=>e.jsx(A,{value:h,children:h},h))]})]})]})})})}const Ae={Theory:"bg-blue-50 text-blue-700 border-blue-200",Lab:"bg-purple-50 text-purple-700 border-purple-200"},O=["Theory","Lab"],qe=["subject_name","subject_code","credits","semester","type","hours_per_week"],H=[{key:"subject_name",label:"Name",width:"w-[18%]"},{key:"subject_code",label:"Code",width:"w-[10%]"},{key:"semester",label:"Semester",width:"w-[10%]"},{key:"type",label:"Type",width:"w-[12%]"},{key:"credits",label:"Credits",width:"w-[8%]"},{key:"hours_per_week",label:"Hours/Week",width:"w-[12%]"},{key:"actions",label:"",width:"w-[10%]"}],te=Object.freeze(["Theory","Lab"]),Le=Object.freeze({theory:"Theory",lab:"Lab"});Object.freeze(te.reduce((t,r)=>(t[r]=r.toLowerCase(),t),{}));function re(t,{strict:r=!1,fallback:c=null}={}){if(t==null){if(r)throw new Error("Subject type missing (received null/undefined).");return c}const i=String(t).trim().toLowerCase();if(!i){if(r)throw new Error("Subject type is an empty string after trimming.");return c}const n=Le[i];if(n)return n;if(r)throw new Error(`Invalid subject type "${t}". Allowed: ${te.join(", ")}`);return c}async function Ie(t){const r=re(t?.type??t?.subject_type,{fallback:"Theory"}),c={...t,type:r??"Theory"},{data:i,error:n}=await V.from("subjects").insert([c]).select("*").single();if(n)throw new Error(n.message||"Failed to create subject");return i}async function Fe({id:t,updates:r}){let c=r;const i=r?.type??r?.subject_type;if(i!==void 0){const m=re(i,{fallback:"Theory"});c={...r,type:m??"Theory"}}const{data:n,error:x}=await V.from("subjects").update(c).eq("id",t).select("*").single();if(x)throw new Error(x.message||"Failed to update subject");return n}async function De(t){const{error:r}=await V.from("subjects").delete().eq("id",t);if(r)throw new Error(r.message||"Failed to delete subject");return{id:t}}function ae({createOptions:t,updateOptions:r,deleteOptions:c}={}){const i=ce(),n=Q({mutationFn:Ie,onSuccess:async(a,u,d)=>{i.setQueryData(E.subjects.all,o=>{const h=Array.isArray(o)?o:[];return[a,...h]}),await i.invalidateQueries({queryKey:E.subjects.all}),t?.onSuccess&&t.onSuccess(a,u,d)},onError:(a,u,d)=>{t?.onError&&t.onError(a,u,d)},...t}),x=Q({mutationFn:Fe,onSuccess:async(a,u,d)=>{i.setQueryData(E.subjects.all,o=>Array.isArray(o)?o.map(h=>h?.id===a?.id?{...h,...a}:h):o),await i.invalidateQueries({queryKey:E.subjects.all}),r?.onSuccess&&r.onSuccess(a,u,d)},onError:(a,u,d)=>{r?.onError&&r.onError(a,u,d)},...r}),m=Q({mutationFn:De,onSuccess:async(a,u,d)=>{const o=a?.id??u;i.setQueryData(E.subjects.all,h=>Array.isArray(h)?h.filter(f=>f?.id!==o):h),await i.invalidateQueries({queryKey:E.subjects.all}),c?.onSuccess&&c.onSuccess(a,u,d)},onError:(a,u,d)=>{c?.onError&&c.onError(a,u,d)},...c});return{createSubject:n.mutate,createSubjectAsync:n.mutateAsync,updateSubject:x.mutate,updateSubjectAsync:x.mutateAsync,deleteSubject:m.mutate,deleteSubjectAsync:m.mutateAsync,createStatus:n,updateStatus:x,deleteStatus:m}}function ze(){const{createSubjectAsync:t,updateSubjectAsync:r}=ae(),{subjects:c}=K(),[i,n]=S.useState(""),[x,m]=S.useState(!1),a=async u=>{const d=u.target.files[0];if(d){m(!0),n("");try{const o=await be(d),f=o[0].map(p=>p&&typeof p=="string"?p.toLowerCase():""),U=qe.filter(p=>!f.includes(p.toLowerCase()));if(U.length>0){n(`Missing columns: ${U.join(", ")}`),m(!1);return}const w={};f.forEach((p,j)=>{w[p]=j});const _=[],q=[];for(let p=1;p<o.length;p++){const j=o[p];if(j.every(b=>b===null||b===""))continue;const y={subject_name:j[w.subject_name]||"",subject_code:j[w.subject_code]||"",credits:parseInt(j[w.credits]||""),department:j[w.department]||"",semester:j[w.semester]||"",type:j[w.type]||"",hours_per_week:parseInt(j[w.hours_per_week])||3},$=c.find(b=>b.credits===y.credits||b.department===y.department||b.semester===y.semester||b.type===y.type||b.hours_per_week===y.hours_per_week||b.subject_code.toLowerCase()===y.subject_code.toLowerCase());$?q.push({id:$.id,updates:y}):_.push(y)}if(_.length===0&&q.length===0){n("No valid subject data found in the file"),m(!1);return}let v=0,L=0,N=[];for(const p of _)try{await t(p),v++}catch(j){N.push(`Add error for ${p.subject_name}: ${j.message}`)}for(const{id:p,updates:j}of q)try{await r({id:p,updates:j}),L++}catch(y){N.push(`Update error for ${j.subject_name}: ${y.message}`)}N.length>0?n(N.join(`
`)):(ie.success(`Successfully imported ${v} new subjects and updated ${L} existing subjects.`),u.target.value=null)}catch(o){n(`Error processing file: ${o.message}`)}m(!1)}};return e.jsxs("div",{children:[e.jsx(g,{variant:"outline",onClick:()=>document.getElementById("excelFileInput").click(),className:"border-blue-300 hover:bg-blue-50",disabled:x,children:x?e.jsxs(e.Fragment,{children:[e.jsx(we,{className:"w-4 h-4 mr-2 animate-spin"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"w-4 h-4 mr-2"}),"Import Excel"]})}),e.jsx("input",{id:"excelFileInput",type:"file",className:"hidden",accept:".xlsx",onChange:a,disabled:x}),i&&e.jsxs(ge,{variant:"destructive",className:"mt-4",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx(Se,{children:i})]})]})}const Be=t=>Ae[t]||"bg-gray-50 text-gray-700  border-border-200";function Me({subjects:t}){const{register:r,handleSubmit:c,reset:i,control:n,formState:{errors:x}}=J(),{register:m,handleSubmit:a,reset:u,control:d,setValue:o,formState:{errors:h}}=J(),{departments:f}=fe(),{isLoading:U}=K(),[w,_]=S.useState(null),[q,v]=S.useState(!1),[L,N]=S.useState(null),{createSubjectAsync:p,updateSubjectAsync:j,deleteSubjectAsync:y}=ae(),$=({subject:s})=>e.jsx(g,{size:"sm",variant:"outline",onClick:()=>{N(s.id),o("subject_name",s.subject_name),o("subject_code",s.subject_code),o("department",s.department),o("semester",s.semester),o("type",s.type),o("credits",s.credits),o("hours_per_week",s.hours_per_week)},children:e.jsx(X,{className:"w-3 h-3"})}),b=({subjectId:s})=>e.jsxs(g,{size:"sm",variant:"outline",onClick:async()=>await y(s),className:"text-red-600 hover:text-red-700",children:[" ",e.jsx(Z,{className:"w-3 h-3"})," "]}),ne=async s=>{await j({id:L,updates:s}),N(null),u()},le=async s=>{await p(s),i(),v(!1)};return e.jsxs(ee,{children:[e.jsx(oe,{children:e.jsxs(ue,{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"w-5 h-5"}),"Subjects (",t.length,")"]}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsxs(g,{onClick:()=>v(!0),disabled:!1,children:[e.jsx(ke,{className:"w-4 h-4 mr-2"})," Add Subject"]}),e.jsx(ze,{})]})]})}),e.jsx(se,{children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(me,{children:[e.jsx(he,{children:e.jsx(P,{children:H.map(s=>e.jsx(pe,{className:s.width,children:s.label},s.key))})}),e.jsxs(je,{children:[e.jsx(_e,{children:U?e.jsx(P,{children:e.jsx(F,{colSpan:8,className:"text-center py-8",children:"Loading subjects..."})}):t.length===0?e.jsx(P,{children:e.jsx(F,{colSpan:8,className:"text-center py-8",children:"No subjects found"})}):t.map((s,C)=>e.jsx(W.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{delay:C*.05},className:"hover:bg-slate-50",onMouseEnter:()=>_(s.id),onMouseLeave:()=>_(null),children:L===s.id?H.map(l=>e.jsxs(F,{children:[l.key==="subject_name"&&e.jsx("input",{type:"text",placeholder:"Subject Name",className:"w-full border px-2 py-1 rounded",...m("subject_name",{required:!0})}),l.key==="subject_code"&&e.jsx("input",{type:"text",placeholder:"Subject Code",className:"w-full border px-2 py-1 rounded",...m("subject_code",{required:!0})}),l.key==="department"&&e.jsx(R,{name:"department",control:d,rules:{required:!0},render:({field:I})=>e.jsxs(D,{value:I.value,onValueChange:I.onChange,children:[e.jsxs(z,{className:"w-full",children:[e.jsx(B,{placeholder:"Department"})," "]}),e.jsx(M,{children:f.map(k=>e.jsx(A,{value:k,children:e.jsx(T,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:k})},k))})]})}),l.key==="semester"&&e.jsx("input",{type:"text",placeholder:"Semester",className:"w-full border px-2 py-1 rounded",...m("semester",{required:!0})}),l.key==="type"&&e.jsx(R,{name:"type",control:d,rules:{required:!0},render:({field:I})=>e.jsxs(D,{value:I.value,onValueChange:I.onChange,children:[e.jsx(z,{className:"w-full",children:e.jsx(B,{placeholder:"Subject Type"})}),e.jsx(M,{children:O.map(k=>e.jsx(A,{value:k,children:e.jsx(T,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:k})},k))})]})}),l.key==="credits"&&e.jsx("input",{placeholder:"Credits",className:"w-full border px-2 py-1 rounded",...m("credits",{required:!0})}),l.key==="hours_per_week"&&e.jsx("input",{placeholder:"Hr/week",className:"w-full border px-2 py-1 rounded",...m("hours_per_week",{required:!0})}),l.key==="actions"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>{N(null),u()},children:e.jsx(G,{className:"w-3 h-3"})}),e.jsx(g,{size:"sm",className:"bg-blue-500 text-white",onClick:a(ne),children:e.jsx(Y,{className:"w-3 h-3"})})]})]},l.key)):H.map(l=>e.jsxs(F,{children:[l.key==="subject_name"&&e.jsx("div",{className:"font-medium",children:s.subject_name}),l.key==="subject_code"&&s.subject_code,l.key==="department"&&e.jsx(T,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:s.department}),l.key==="semester"&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ve,{className:"w-3 h-3 text-slate-400"}),s.semester]}),l.key==="type"&&e.jsxs(T,{variant:"outline",className:Be(s.type),children:[" ",s.type," "]}),l.key==="credits"&&s.credits,l.key==="hours_per_week"&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Te,{className:"w-3 h-3 text-slate-400"}),s.hours_per_week,"h"]}),l.key==="actions"&&e.jsx("div",{className:"flex gap-2",children:w===s.id?e.jsxs(e.Fragment,{children:[e.jsx($,{subject:s}),e.jsx(b,{subjectId:s.id})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{visibility:"hidden"},children:e.jsx(g,{size:"sm",variant:"outline",children:e.jsx(X,{className:"w-3 h-3"})})}),e.jsx("span",{style:{visibility:"hidden"},children:e.jsx(g,{size:"sm",variant:"outline",children:e.jsx(Z,{className:"w-3 h-3"})})})]})})]},l.key))},s.id))}),q&&e.jsx(W.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.3},children:H.map(s=>e.jsxs(F,{children:[s.key==="subject_name"&&e.jsx("input",{type:"text",placeholder:"Subject Name",className:"w-full border px-2 py-1 rounded",...r("subject_name",{required:!0})}),s.key==="subject_code"&&e.jsx("input",{type:"text",placeholder:"Subject Code",className:"w-full border px-2 py-1 rounded",...r("subject_code",{required:!0})}),s.key==="department"&&e.jsx(R,{name:"department",control:n,rules:{required:!0},render:({field:C})=>e.jsxs(D,{value:C.value,onValueChange:C.onChange,children:[e.jsx(z,{className:"w-full",children:e.jsx(B,{placeholder:"Department"})}),e.jsx(M,{children:f.map(l=>e.jsx(A,{value:l,children:e.jsx(T,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:l})},l))})]})}),s.key==="semester"&&e.jsx("input",{type:"text",placeholder:"Semester",className:"w-full border px-2 py-1 rounded",...r("semester",{required:!0})}),s.key==="type"&&e.jsx(R,{name:"type",control:n,rules:{required:!0},render:({field:C})=>e.jsxs(D,{value:C.value,onValueChange:C.onChange,children:[e.jsx(z,{className:"w-full",children:e.jsx(B,{placeholder:"Subject Type"})}),e.jsx(M,{children:O.map(l=>e.jsx(A,{value:l,children:e.jsx(T,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:l})},l))})]})}),s.key==="credits"&&e.jsx("input",{placeholder:"Credits",className:"w-full border px-2 py-1 rounded",...r("credits",{required:!0})}),s.key==="hours_per_week"&&e.jsx("input",{placeholder:"Hr/week",className:"w-full border px-2 py-1 rounded",...r("hours_per_week",{required:!0})}),s.key==="actions"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{size:"sm",variant:"outline",onClick:()=>{i(),v(!1)},children:e.jsx(G,{className:"w-3 h-3"})}),e.jsx(g,{size:"sm",className:"bg-blue-500 text-white",onClick:c(le),children:e.jsx(Y,{className:"w-3 h-3"})})]})]},s.key))})]})]})})})]})}function us(){const{subjects:t,departments:r}=K(),[c,i]=S.useState(""),[n,x]=S.useState(null),m=S.useMemo(()=>t.filter(a=>{const u=a.subject_name.toLowerCase().includes(c.toLowerCase())||a.subject_code.toLowerCase().includes(c.toLowerCase()),d=!n||a.department===n;return u&&d}),[t,c,n]);return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Subjects Management"}),e.jsx("p",{className:"text-slate-600",children:"Manage course subjects and curriculum"})]})}),e.jsx(Ee,{departments:r,searchTerm:c,selectedDepartment:n,onSearchChange:i,onDepartmentChange:a=>x(a==="all"?null:a)}),e.jsx(Me,{subjects:m})]})}export{us as default};
