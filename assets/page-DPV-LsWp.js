import{r as E,R as d,u as F,s as v}from"./index-DtPpba_i.js";import{a as C,b as S,c as k,d as D,e as w,T as H}from"./table-mMg1kOn4.js";import{B as q}from"./badge-c-rzC1cp.js";import{u as N,q as R}from"./queryKeys-DEtgRCDz.js";import"./utils-Dm1jtZiZ.js";import"./index-CT9tpGOu.js";const M=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];function j(a){return typeof a=="string"&&/^\d{2}:\d{2}$/.test(a)}function g(a){const t=String(a??"");return t.length===1?`0${t}`:t}function h(a){if(a==null)return a;if(a instanceof Date){const i=g(a.getHours()),l=g(a.getMinutes());return`${i}:${l}`}let t=String(a).trim();if(t.length===0||j(t))return t;if(/^\d:\d{2}$/.test(t)){const[i,l]=t.split(":");return`${g(i)}:${l}`}if(/^\d{1,2}:\d{2}:\d{1,2}$/.test(t)){const[i,l]=t.split(":");return`${g(i)}:${g(l)}`}if(/^\d{1,2}:\d{2}:\d{1,2}\.\d+$/.test(t)){const[i,l]=t.split(":");return`${g(i)}:${g(l)}`}if(/^\d{3,4}$/.test(t)){const i=Number(t);if(Number.isFinite(i)){const l=Math.floor(i/100),p=i%100;return`${g(l)}:${g(p)}`}}if(/^\d{1,2}\.\d{2}$/.test(t)){const[i,l]=t.split(".");return`${g(i)}:${g(l)}`}const c=t.match(/(\d{1,2}):(\d{2})/);return c?`${g(c[1])}:${g(c[2])}`:t}function L(a,{breakAfterTime:t,breakAfterSlotIndex:c,entriesForFallback:i,fallbackToDayOrder:l=!0}={}){return E.useMemo(()=>{const p=(r,e)=>{const o=typeof r?.slot=="number",f=typeof e?.slot=="number";if(o&&f)return r.slot-e.slot;if(o&&!f)return-1;if(!o&&f)return 1;const b=h(r?.start_time),x=h(e?.start_time);return b&&x&&b!==x?b<x?-1:1:String(r?.id??"").localeCompare(String(e?.id??""))},u={},y=Array.isArray(a)?a:[];for(const r of y){const e=r?.day??r?.Day??r?.day_name??r?.dayName??r?.weekday??r?.week_day;e&&(u[e]||(u[e]=[]),u[e].push(r))}const $=r=>{const e=M.indexOf(r);return e===-1?Number.MAX_SAFE_INTEGER:e};let s=Object.keys(u);if(s.length===0&&Array.isArray(i)&&i.length>0){const r=new Set;for(const e of i){const o=e?.time_slots?.day??e?.time_slots?.day_name??e?.time_slots?.dayName??e?.time_slots?.weekday??e?.day;o&&r.add(o)}if(r.size>0){s=Array.from(r);const e=[...y].sort(p);for(const o of s)u[o]=e.map(f=>f);console.warn("[useTimetableStructure] timeSlots missing 'day'; derived days from entries and replicated slot timeline.",{days:s,protoCount:e.length})}}if(s.length===0&&l){s=M.slice(0,5);const r=[...y].sort(p);for(const e of s)u[e]=r.map(o=>o);console.warn("[useTimetableStructure] No day info found in timeSlots or entries; defaulting to first 5 days of DAY_ORDER.",{days:s})}s.sort((r,e)=>{const o=$(r),f=$(e);return o!==f?o-f:r.localeCompare(e)});for(const r of s)(u[r]||=[]).sort(p);const n={},m=t?h(t):null;for(const r of s){const e=u[r]||[];let o=-1;if(m){const f=e.findIndex(b=>h(b?.start_time)===m);f!==-1&&(o=f)}o===-1&&typeof c=="number"&&c>=0&&(o=Math.min(Math.max(0,c),Math.max(0,e.length-1))),o===-1&&e.length>0&&(o=Math.floor(e.length/2)),n[r]=o}return{days:s,slotsByDay:u,breakIndexByDay:n}},[a,t,c,i,l])}function K({days:a,slotsByDay:t,breakIndexByDay:c,selectedDay:i,onDayClick:l,breakLabel:p="Break"}){const u=s=>i===null||i===s,y=(s,n)=>(c?.[s]??-1)!==-1&&n===c[s],$=s=>{const n=h(s?.start_time),m=h(s?.end_time);return n&&m?`${n}-${m}`:typeof s?.slot=="number"?`Slot ${s.slot+1}`:"Time"};return d.createElement(C,null,d.createElement(S,null,d.createElement(k,{className:"border border-border p-2 min-w-[80px]"}),a.map(s=>{const n=(t?.[s]||[]).length||1,m=u(s);return d.createElement(k,{key:s,colSpan:n,onClick:()=>l?.(s),className:`border border-border p-3 text-center cursor-pointer transition-all duration-300 ${m?"bg-accent text-accent-foreground":"bg-muted text-muted-foreground opacity-60"}`},d.createElement("span",null,s.toLowerCase()))})),d.createElement(S,null,d.createElement(k,{className:"border border-border p-2"}),a.flatMap(s=>{const n=t?.[s]||[],m=u(s);return n.map((r,e)=>{const o=y(s,e);return d.createElement(k,{key:`${s}-${e}`,className:`border border-border p-2 text-xs min-w-[100px] transition-all duration-300 ${m?o?"dark:bg-amber-950/30":"":"opacity-60"}`},d.createElement("div",{className:"flex flex-col items-center gap-1"},d.createElement("span",{className:o?"text-muted-foreground text-[10px] dark:text-amber-300":"text-[10px]"},o?p:$(r))))})})))}const O=E.memo(K);function B({lecture:a,isBreak:t}){return t?React.createElement("div",{className:"w-full h-full flex items-center justify-center"},React.createElement("div",{className:"text-[10px] py-1 px-2 rounded-md bg-amber-50 text-amber-700 text-center border border-amber-200 dark:bg-amber-950/30 dark:text-amber-300 dark:border-amber-900/40"},"Break")):a?React.createElement("div",{className:"w-full h-full p-1.5"},React.createElement("div",{className:"h-full bg-gradient-to-br from-[#EEF5FF] to-[#DBEAFF] dark:bg-secondary dark:bg-none border border-[#B8D4F1] dark:border-border rounded-lg p-1.5 flex flex-col gap-1.5 shadow-sm hover:shadow-md transition-shadow"},React.createElement("div",{className:"text-[#1E3A5F] dark:text-foreground text-[10px] leading-snug break-words line-clamp-2 shrink-0 min-h-[14px]"},a.subject),React.createElement("div",{className:"space-y-0.5 shrink-0"},React.createElement("div",{className:"text-[#4A7BA7] dark:text-muted-foreground text-[8px] leading-snug truncate"},a.teacher),React.createElement("div",{className:"text-[#4A7BA7] dark:text-muted-foreground text-[8px] leading-snug truncate"},"Room: ",a.room)),React.createElement("div",{className:"flex-1"}),React.createElement("div",{className:"flex justify-start"},React.createElement(q,{variant:"secondary",className:"text-[10px] px-1.5 py-0.5 leading-none bg-[#DBEAFE] text-[#1E40AF] border border-[#93C5FD] dark:bg-secondary dark:text-secondary-foreground dark:border-border"},a.type)))):React.createElement("div",{className:"w-full h-full flex items-center justify-center"},React.createElement("div",{className:"text-[10px] py-1 px-2 rounded-md bg-muted text-muted-foreground text-center"},"—"))}function Q({days:a,slotsByDay:t,breakIndexByDay:c,classLabels:i,timetableEntries:l,selectedDay:p}){const u=n=>p===null||p===n,y=n=>n?{subject:n.subject_name??n.subject??"—",teacher:n.teacher_name??n.teacher??"—",room:n.room_name??n.room??String(n.room_id??"—"),type:n.type??"Lecture"}:null,$=E.useMemo(()=>{const n=new Map;for(const m of Array.isArray(l)?l:[]){const r=m?.class_name??"Unknown",e=m?.time_slots?.day,o=h(m?.time_slots?.start_time);!r||!e||!o||n.set(`${r}|${e}|${o}`,m)}return n},[l]),s=E.useMemo(()=>{const n=new Map;for(const m of Array.isArray(l)?l:[]){const r=m?.class_name??"Unknown",e=m?.time_slots?.day,o=typeof m?.time_slots?.slot=="number"?m.time_slots.slot:null;!r||!e||o==null||n.set(`${r}|${e}|${o}`,m)}return n},[l]);return d.createElement(D,null,i.map(n=>d.createElement(S,{key:n},d.createElement(w,{className:"border border-border p-3 text-center"},d.createElement("span",{className:"text-foreground"},n)),a.flatMap(m=>{const r=t?.[m]||[],e=c?.[m]??-1,o=u(m);return r.map((f,b)=>{if(b===e)return d.createElement(w,{key:`${n}-${m}-${b}`,className:`border border-border text-xs h-[120px] transition-all duration-300 ${o?"dark:bg-amber-950/30":"opacity-60"}`},d.createElement(B,{lecture:null,isBreak:!0}));const _=e!==-1&&b>e?h(r[b-1]?.start_time):h(f?.start_time),T=e!==-1&&b>e?r[b-1]?.slot:f?.slot,A=(_?$.get(`${n}|${m}|${_}`):null)??(typeof T=="number"?s.get(`${n}|${m}|${T}`):null)??null;return d.createElement(w,{key:`${n}-${m}-${b}`,className:`border border-border text-xs h-[120px] transition-all duration-300 ${o?"":"opacity-60"}`},d.createElement(B,{lecture:y(A),isBreak:!1}))})}))))}const I=E.memo(Q);async function P(a){const{data:t,error:c}=await v.from("classes").select("*").eq("department_id",a).order("created_at",{ascending:!1});if(c)throw new Error(c.message||"Failed to fetch classes");return t??[]}async function U(a){const{data:t,error:c}=await v.from("time_slots").select("*").eq("department_id",a).order("day",{ascending:!0}).order("slot",{ascending:!0});if(c)throw new Error(c.message||"Failed to fetch time slots");return t??[]}async function W(a){const{data:t,error:c}=await v.from("timetable_entries").select("*, time_slots(*)").eq("department_id",a);if(c)throw console.error("Error While Fetching timetable_entries: ",c),new Error(`Error While Fetching timetable_entries: ${c.message}`);return t||[]}function z(){const a=F(l=>l.auth.user?.department_id),t=N({queryKey:R.classes.all,staleTime:6e4,queryFn:()=>P(a)}),c=N({queryKey:R.timeSlots.all,staleTime:6e4,queryFn:()=>U(a)}),i=N({queryKey:[R.timetableEntries.all],queryFn:()=>W(a),staleTime:6e4});return{isLoading:i.isPending||c.isPending||t.isPending,isError:i.isError||c.isError||t.isError,error:i.error||c.error||t.error,timetableEntries:i.data,timeSlots:c.data,classes:t.data}}function G(a,t){return E.useMemo(()=>{const c=(a||[]).map(l=>(l?.class_name??l?.name??`Class ${l?.id??""}`).trim()).filter(Boolean);if(c.length>0)return Array.from(new Set(c));const i=new Set((t||[]).map(l=>l?.class_name??"Unknown"));return Array.from(i)},[a,t])}function V({breakAfterTime:a,breakAfterSlotIndex:t,breakLabel:c="Break"}){const{classes:i,timeSlots:l,timetableEntries:p,isLoading:u,isError:y,error:$}=z(),{days:s,slotsByDay:n,breakIndexByDay:m}=L(l,{breakAfterTime:a,breakAfterSlotIndex:t,entriesForFallback:p}),[r,e]=E.useState(null),o=E.useCallback(x=>e(_=>_===x?null:x),[]),f=E.useCallback(x=>r===null||r===x,[r]),b=G(i,p);return React.createElement("div",{className:"border border-border rounded-2xl p-8 bg-card shadow-sm"},React.createElement("div",{className:"mb-6 flex items-center justify-between gap-4"},React.createElement("h1",{className:"text-foreground text-xl"},"Timetable")),y?React.createElement("div",{className:"mb-4 p-3 rounded-md bg-red-50 text-red-700 border border-red-200"},$?.message||"Something went wrong while loading the timetable."):u?React.createElement("div",{className:"text-gray-600"},"Loading timetable..."):React.createElement("div",{className:"overflow-x-auto"},React.createElement(H,{className:"w-full border-collapse"},React.createElement(O,{days:s,slotsByDay:n,breakIndexByDay:m,selectedDay:r,onDayClick:o,breakLabel:c}),React.createElement(I,{days:s,slotsByDay:n,breakIndexByDay:m,classLabels:b,timetableEntries:p,selectedDay:r,isActiveDay:f}))))}function re(){return React.createElement("div",{className:"min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 dark:from-background dark:via-background dark:to-background p-8 "},React.createElement("div",{className:"max-w-[1800px] mx-auto"},React.createElement(V,null)))}export{re as default};
